# üìã –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ SP-2: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

## üìä –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ

| ‚Ññ | –ò—Ç–µ—Ä–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | –î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è |
|---|----------|--------|--------------|-----------------|
| 1 | –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | - | 2025-10-16 |
| 2 | –ú–æ–¥–µ–ª—å User –∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | ‚úÖ 100% coverage | 2025-10-16 |
| 3 | UserRepository | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | - | - |
| 4 | –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | - | - |
| 5 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | - | - |
| 6 | –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ | ‚è≥ –û–∂–∏–¥–∞–µ—Ç | - | - |

**–õ–µ–≥–µ–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:**
- ‚è≥ –û–∂–∏–¥–∞–µ—Ç
- üîÑ –í —Ä–∞–±–æ—Ç–µ
- ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã

---

## üîç –ò—Ç–µ—Ä–∞—Ü–∏—è 1: –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¶–µ–ª—å:** –ò–∑—É—á–∏—Ç—å Telegram User API –∏ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ó–∞–¥–∞—á–∏

**–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:**
- [x] –ò–∑—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é aiogram 3.x –∏ Telegram Bot API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ `message.from_user`
- [x] –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ handlers.py –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Ö —Ç–∏–ø—ã
- [x] **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `messages` - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (chat_id + user_id)
  - –û—Ü–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∑–∞–ø–∏—Å–µ–π –≤ `users`
  - –°–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î:**
- [x] –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `users` —Å –ø–æ–ª—è–º–∏:
  - `user_id` (BigInteger, PK) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
  - `username` (String) - username (–±–µ–∑ @)
  - `first_name` (String) - –∏–º—è
  - `last_name` (String, nullable) - —Ñ–∞–º–∏–ª–∏—è
  - `bio` (Text, nullable) - –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
  - `age` (Integer, nullable) - –≤–æ–∑—Ä–∞—Å—Ç (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–±–æ—Ä)
  - `created_at` (DateTime) - –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  - `updated_at` (DateTime) - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- [x] –°–æ–∑–¥–∞—Ç—å ER-–¥–∏–∞–≥—Ä–∞–º–º—É (—Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–ª–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é)
- [x] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–≤—è–∑–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π `messages` (foreign key –Ω–∞ user_id)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
- [x] –û–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏)

### –†–µ–∑—É–ª—å—Ç–∞—Ç
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –ø–æ–ª—è–º Telegram User (`docs/database_schema.md`)
- ‚úÖ ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—Å—Ç–æ–≤–∞—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
- ‚úÖ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã `users` —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö: 4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 30 —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üíæ –ò—Ç–µ—Ä–∞—Ü–∏—è 2: –ú–æ–¥–µ–ª—å User –∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å SQLAlchemy –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–∏–≥—Ä–∞—Ü–∏—é Alembic

### –ó–∞–¥–∞—á–∏

**–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (TDD):**
- [x] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ User
- [x] üü¢ GREEN: –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `User` –≤ `db_models.py` —Å –ø–æ–ª—è–º–∏:
  - `user_id`, `username`, `first_name`, `last_name`
  - `bio`, `age`, `created_at`, `updated_at`
- [x] üîµ REFACTOR: –î–æ–±–∞–≤–∏—Ç—å type hints, docstring, –∏–Ω–¥–µ–∫—Å—ã
- [x] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `__repr__` –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
- [x] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é Alembic: `alembic revision --autogenerate -m "add users table"`
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `alembic upgrade head`
- [x] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ PostgreSQL

**–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- [x] –°–æ–∑–¥–∞—Ç—å data-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è user_id –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `messages`
- [x] –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `users` –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
  - `user_id` –∏–∑ messages (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
  - `username`, `first_name`, `last_name` - NULL (–±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏)
  - `created_at` - MIN(created_at) –∏–∑ messages –¥–ª—è –∫–∞–∂–¥–æ–≥–æ user_id
  - `updated_at` - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ user_id –∏–∑ messages —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –≤ users

**–ü—Ä–∏–º–µ—Ä SQL –¥–ª—è data-–º–∏–≥—Ä–∞—Ü–∏–∏:**
```sql
INSERT INTO users (user_id, username, first_name, last_name, created_at, updated_at)
SELECT DISTINCT 
    user_id,
    NULL as username,
    NULL as first_name, 
    NULL as last_name,
    MIN(created_at) as created_at,
    CURRENT_TIMESTAMP as updated_at
FROM messages
WHERE deleted_at IS NULL
GROUP BY user_id
ON CONFLICT (user_id) DO NOTHING;
```

**Seed –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- [x] ~~–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)~~ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [x] ~~–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–∞–∑–Ω—ã–º–∏ –Ω–∞–±–æ—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö~~ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –¢–µ—Å—Ç
```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
make db-migrate-create MESSAGE="add users table"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
make db-migrate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î
docker exec -it systech-aidd-postgres psql -U postgres -d systech_aidd -c "\d users"

# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü–∞ users —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏

# –°–æ–∑–¥–∞—Ç—å data-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
make db-migrate-create MESSAGE="migrate existing users from messages"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å data-–º–∏–≥—Ä–∞—Ü–∏—é
make db-migrate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª–∏
docker exec -it systech-aidd-postgres psql -U postgres -d systech_aidd

# –í psql –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
SELECT COUNT(DISTINCT user_id) FROM messages WHERE deleted_at IS NULL;
SELECT COUNT(*) FROM users;
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT user_id, username, first_name, created_at FROM users LIMIT 5;
```

---

## üóÑÔ∏è –ò—Ç–µ—Ä–∞—Ü–∏—è 3: UserRepository

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –ó–∞–¥–∞—á–∏

**–°–æ–∑–¥–∞–Ω–∏–µ UserRepository (TDD):**

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å 1: –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- [ ] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `upsert_user()` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] üü¢ GREEN: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `upsert_user()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] üü¢ GREEN: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (upsert)
- [ ] üîµ REFACTOR: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥, –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID**
- [ ] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `get_user_by_id()`
- [ ] üü¢ GREEN: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] üîµ REFACTOR: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª—É—á–∞—è –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
- [ ] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `get_user_message_count()` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] üü¢ GREEN: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] üîµ REFACTOR: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å

**–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞:**
- [ ] –°–æ–∑–¥–∞—Ç—å `src/user_repository.py` —Å –∫–ª–∞—Å—Å–æ–º `UserRepository`
- [ ] –î–æ–±–∞–≤–∏—Ç—å type hints –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å docstrings —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—Ä—ã –º–µ—Ç–æ–¥–æ–≤
```python
class UserRepository:
    async def upsert_user(self, user_data: dict) -> User:
        """–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
    async def get_user_by_id(self, user_id: int) -> User | None:
        """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        
    async def get_user_message_count(self, user_id: int) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
```

### –¢–µ—Å—Ç
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
make test tests/test_user_repository.py

# –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏
```

---

## üì° –ò—Ç–µ—Ä–∞—Ü–∏—è 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram API

### –ó–∞–¥–∞—á–∏

**–°–æ–∑–¥–∞–Ω–∏–µ utility —Ñ—É–Ω–∫—Ü–∏–π:**
- [ ] üî¥ RED: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è `extract_user_data()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `message.from_user`
- [ ] üü¢ GREEN: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- [ ] üîµ REFACTOR: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª—É—á–∞–∏ –∫–æ–≥–¥–∞ –ø–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç

**–°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö:**
- [ ] –°–æ–∑–¥–∞—Ç—å dataclass `UserData` –≤ `models.py` —Å –ø–æ–ª—è–º–∏:
  - `user_id`, `username`, `first_name`, `last_name`
- [ ] –î–æ–±–∞–≤–∏—Ç—å type hints –∏ validation
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ dict –¥–ª—è –ë–î

**–û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases:**
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª—É—á–∞–π –∫–æ–≥–¥–∞ `username` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª—É—á–∞–π –∫–æ–≥–¥–∞ `last_name` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–º–µ—Ä—ã
```python
@dataclass(frozen=True)
class UserData:
    """–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram"""
    user_id: int
    username: str | None
    first_name: str
    last_name: str | None

def extract_user_data(telegram_user: TelegramUser) -> UserData:
    """–ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –æ–±—ä–µ–∫—Ç–∞"""
```

### –¢–µ—Å—Ç
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
make test tests/test_models.py

# –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å:
# - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
# - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ optional –ø–æ–ª—è–º–∏
# - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ dict
```

---

## üîó –ò—Ç–µ—Ä–∞—Ü–∏—è 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

### –ó–∞–¥–∞—á–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å `UserRepository` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ handlers
- [ ] –í `handle_message()` –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `upsert_user()` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É upsert –¥–ª—è –¥–≤—É—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**
  - **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** (–∏–∑ messages): –æ–±–Ω–æ–≤–∏—Ç—å username, first_name, last_name, updated_at
  - **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Telegram
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö (graceful degradation)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–æ–∑–¥–∞–Ω–∏–µ)
  - –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py:**
- [ ] –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä `UserRepository` —á–µ—Ä–µ–∑ DI
- [ ] –ü–µ—Ä–µ–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ä–æ—É—Ç–µ—Ä —á–µ—Ä–µ–∑ dependency injection

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ handlers.py
```python
async def handle_message(
    message: Message,
    llm_client: LLMClient,
    conversation_manager: ConversationManager,
    user_repository: UserRepository,  # –ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
    system_prompt: str,
) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ LLM —Å –∏—Å—Ç–æ—Ä–∏–µ–π"""
    if message.from_user is None or message.text is None:
        return
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        user_data = extract_user_data(message.from_user)
        await user_repository.upsert_user(user_data)
    except Exception as e:
        logger.error(f"Failed to save user data: {e}")
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

### –¢–µ—Å—Ç
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
make run

# –í Telegram –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å

docker exec -it systech-aidd-postgres psql -U postgres -d systech_aidd -c "SELECT * FROM users;"

# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

---

## ‚úÖ –ò—Ç–µ—Ä–∞—Ü–∏—è 6: –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

**–¶–µ–ª—å:** –ü–æ–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏

### –ó–∞–¥–∞—á–∏

**Unit —Ç–µ—Å—Ç—ã:**
- [ ] `test_user_repository.py`:
  - –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (upsert)
  - –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
  - –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] `test_models.py`:
  - –¢–µ—Å—Ç UserData dataclass
  - –¢–µ—Å—Ç extract_user_data()
  - –¢–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ dict
- [ ] `test_db_models.py`:
  - –¢–µ—Å—Ç –º–æ–¥–µ–ª–∏ User
  - –¢–µ—Å—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ constraints

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
- [ ] `test_user_integration.py`:
  - –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –ë–î
  - –¢–µ—Å—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è UserRepository + MessageRepository
  - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ handlers
  - **–¢–µ—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:**
    - –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (user_id, created_at)
    - –í—ã–∑–≤–∞—Ç—å upsert —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Telegram
    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å (username, first_name, last_name)
  - **–¢–µ—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
    - –í—ã–∑–≤–∞—Ç—å upsert –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–∑–¥–∞–ª–∞—Å—å –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å testcontainers:**
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç testcontainers
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö
- [ ] –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã

**Coverage:**
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `make test-cov`
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π > 80%
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã—Ö –≤–µ—Ç–æ–∫ –∫–æ–¥–∞

### –¢–µ—Å—Ç
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
make test

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ
make test-cov

# –¶–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
# - –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (–∑–µ–ª—ë–Ω—ã–µ)
# - Coverage –¥–ª—è user_repository.py > 90%
# - Coverage –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ models.py > 85%
# - –û–±—â–∏–π coverage –ø—Ä–æ–µ–∫—Ç–∞ > 80%

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
make quality

# –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏:
# - ruff format
# - ruff check
# - mypy (strict mode)
```

---

## üìù –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

**–ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Å–ø—Ä–∏–Ω—Ç–∞:**

- [ ] –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ú–æ–¥–µ–ª—å User —Å–æ–∑–¥–∞–Ω–∞ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
- [ ] UserRepository —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ Telegram
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ handlers —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (–∑–µ–ª—ë–Ω—ã–µ)
- [ ] –í—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage > 80% –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- [ ] `make quality` –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] README.md –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
docker exec -it systech-aidd-postgres psql -U postgres -d systech_aidd

# –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
SELECT user_id, username, first_name, last_name, created_at 
FROM users 
WHERE username IS NULL;  -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ data-–º–∏–≥—Ä–∞—Ü–∏–∏

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
make run

# 3. –í Telegram (–æ—Ç –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
"–ü—Ä–∏–≤–µ—Ç" ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
docker exec -it systech-aidd-postgres psql -U postgres -d systech_aidd

SELECT user_id, username, first_name, last_name, created_at, updated_at 
FROM users 
WHERE user_id = <ID_—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>;
# –¢–µ–ø–µ—Ä—å username, first_name, last_name –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã

# 5. –í Telegram (–æ—Ç –ù–û–í–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
/start ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"–ü—Ä–∏–≤–µ—Ç" ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
SELECT user_id, username, first_name, last_name, created_at 
FROM users 
WHERE user_id = <ID_–Ω–æ–≤–æ–≥–æ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è>;
# –í—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Å—Ä–∞–∑—É

# 7. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT u.user_id, u.username, u.first_name, COUNT(m.id) as message_count
FROM users u
LEFT JOIN messages m ON u.user_id = m.user_id AND m.deleted_at IS NULL
GROUP BY u.user_id, u.username, u.first_name
ORDER BY message_count DESC;

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# - –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
# - –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
# - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
```

---

## üìö –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **KISS** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è
- **1 –∫–ª–∞—Å—Å = 1 —Ñ–∞–π–ª** - —Å—Ç—Ä–æ–≥–æ–µ –ø—Ä–∞–≤–∏–ª–æ
- **Type hints –≤–µ–∑–¥–µ** - mypy strict mode
- **TDD —Ü–∏–∫–ª**: RED ‚Üí GREEN ‚Üí REFACTOR –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- **Async/await** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- PostgreSQL 16 + SQLAlchemy 2.x (async)
- Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
- aiogram 3.x –¥–ª—è Telegram Bot API
- pytest + testcontainers –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- Type hints + mypy –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

**–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
- **–î–≤–∞ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
  - **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ** - —É–∂–µ –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`, –Ω–æ –Ω–µ—Ç –≤ `users` (–Ω—É–∂–Ω–∞ data-–º–∏–≥—Ä–∞—Ü–∏—è)
  - **–ù–æ–≤—ã–µ** - –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
- Data-–º–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (user_id, created_at)
- –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (username, first_name, last_name) –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —á–µ—Ä–µ–∑ upsert

**–†–∞–±–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
- Graceful degradation: –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–¥–∞–ª–æ—Å—å, –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ username, last_name –∏ —Ç.–¥.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ upsert –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –†–∞–±–æ—Ç–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

**MCP Context7 (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
- –ò—Å–ø–æ–ª—å–∑—É–π `resolve-library-id` –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π `get-library-docs` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤–µ—Ä—è–π—Å—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –ø—Ä–∏:
  - –†–∞–±–æ—Ç–µ —Å aiogram 3.x (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `message.from_user`)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ SQLAlchemy 2.x (–º–æ–¥–µ–ª–∏, –º–∏–≥—Ä–∞—Ü–∏–∏)
  - –†–∞–±–æ—Ç–µ —Å pydantic (dataclasses, –≤–∞–ª–∏–¥–∞—Ü–∏—è)

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Context7:**
```bash
# –ü–æ–∏—Å–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ aiogram
resolve-library-id libraryName="aiogram"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ User type
get-library-docs context7CompatibleLibraryID="/aiogram/aiogram" topic="User type"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ SQLAlchemy async
get-library-docs context7CompatibleLibraryID="/sqlalchemy/sqlalchemy" topic="async session"
```

**–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:**
- [aiogram 3.x User type](https://docs.aiogram.dev/en/latest/api/types/user.html)
- [Telegram Bot API User](https://core.telegram.org/bots/api#user)
- [SQLAlchemy 2.x Async](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [Alembic Migrations](https://alembic.sqlalchemy.org/en/latest/tutorial.html)

---

## üéØ –ò—Ç–æ–≥–∏ —Å–ø—Ä–∏–Ω—Ç–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø—Ä–∏–Ω—Ç–∞ SP-2:
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å User —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã messages**
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç upsert –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ > 80%
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (ruff, mypy) –ø—Ä–æ—Ö–æ–¥—è—Ç

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ messages —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –≤ users
- –ü—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ø—Ä–∏–Ω—Ç—É.

